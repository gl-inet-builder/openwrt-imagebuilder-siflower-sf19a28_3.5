#!/bin/sh

. /lib/functions/gl_util.sh

model=$(get_model)

led="/dev/null"

case "$model" in
	"ar150"|\
	"mifi"|\
	"ar300"|\
	"ar300m")
		led="/sys/class/leds/gl-${model}:green:lan/brightness"
		;;
	"x300b")
		led="/sys/class/leds/gl-${model}:green:wan/brightness"
		;;
	"mt300a"|\
	"mt300n"|\
	"mt300n-v2")
		led="/sys/class/leds/gl-${model}:blue:wan/brightness"
		;;
	"usb150")
		led="/sys/class/leds/gl-${model}:green:power/brightness"
		;;
	"ar750s"|\
	"x750"|\
	"ar750")
		led="/sys/class/leds/gl-$model:white:power/brightness"
		;;		
	"b1300"|\
	"s1300"|\
	"ap1300")
		led="/sys/class/leds/power_led/brightness"
		;;
	"b2200")
		led="/sys/class/leds/power_white_led/brightness"
		;;
	"x1200")
		led="/sys/class/leds/gl-${model}:red:system/brightness"
		;;
	"mv1000")
		led="/sys/class/leds/gl-mv1000:green:power/brightness"
		;;
	"n300")
		echo 0 > /sys/class/leds/microuter-n300\:white\:wlan/brightness
		led="/sys/class/leds/microuter-${model}:blue:power/brightness"
		;;
	"sf1200")
		echo 0 > /sys/class/leds/gl-sf1200:blue:power/brightness
		led="/sys/class/leds/gl-sf1200:blue:power/brightness"
		;;
	*)
esac

reset_pressed_start=$(date +%s)
reset_pressed_duration=0
reset_pressed_last=0
echo "$reset_pressed_duration" > /tmp/reset_pressed_duration
while [ true ]; do
	now=$(date +%s)
	reset_pressed_duration=$((now-reset_pressed_start))
	echo "$reset_pressed_duration" > /tmp/reset_pressed_duration
	#echo "$reset_pressed_duration" > /dev/console
	[ "$model" = "e750" -a "$reset_pressed_last" != "$reset_pressed_duration" ] && {
		reset_pressed_last=$reset_pressed_duration
		echo {\"button\":\"${reset_pressed_duration}\"} >/tmp/mcu_message
		killall -17 e750-mcu
	}
	#flash leds
	if [ "$reset_pressed_duration" -gt 20 ]; then
		echo 1 > $led
		sleep 1
		echo 0 > $led
		sleep 1
	elif [ "$reset_pressed_duration" -gt 8 ]; then
		echo 1 > $led
		sleep 0.1
		echo 0 > $led
		sleep 0.1
		echo 1 > $led
		sleep 0.1
		echo 0 > $led
		sleep 0.1
		echo 1 > $led
		sleep 0.1
		echo 0 > $led
		sleep 0.1
		echo 1 > $led
		sleep 0.1
		echo 0 > $led
		sleep 0.1
	elif [ "$reset_pressed_duration" -gt 3 ]; then
		echo 1 > $led
		sleep 0.25
		echo 0 > $led
		sleep 0.25
	else
		echo 1 > $led
		sleep 0.5
		echo 0 > $led
		sleep 0.5
	fi

done
